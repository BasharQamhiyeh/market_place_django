{# templates/partials/_item_card.html #}
{% load i18n timeago_ar %}


{% with HIDE_OWNER_FAV=0 %}

<article
  class="ad-card group{% if featured_card %} featured-card vip-card{% endif %}"
  data-href="{% url 'item_detail' item.id %}"
  aria-label="{{ item.listing.title }}"
>

  <!-- IMAGE + CONTROLS -->
  <div class="relative">
    <div class="ad-imgwrap">
      {% with p=item.main_photo %}
        {% if p %}
          <img
            src="{% if p.normalized %}{{ p.normalized.url }}{% else %}{{ p.image.url }}{% endif %}"
            alt="{{ item.listing.title }}"
            loading="lazy"
            decoding="async"
          >
        {% else %}
          <div class="w-full h-full flex items-center justify-center text-sm text-gray-400">
            {% trans "No image" %}
          </div>
        {% endif %}
      {% endwith %}
    </div>


    {% if request.user.is_authenticated %}

      {% if item.listing.user_id == request.user.user_id and HIDE_OWNER_FAV %}
        {# authenticated OWNER #}

          <button
            type="button"
            class="ad-fav-btn absolute bottom-3 left-3 z-20{% if item.is_favorited %} is-active{% endif %}"
            data-fav-btn="1"
            data-guest="0"
            data-is-owner="1"
            data-url="{% url 'toggle_favorite' item.id %}"
            data-favorited="{% if item.is_favorited %}1{% else %}0{% endif %}"
            aria-label="{% trans 'Toggle favorite' %}"
            aria-pressed="{% if item.is_favorited %}true{% else %}false{% endif %}"
          >
            <svg class="w-5 h-5" viewBox="0 0 24 24" aria-hidden="true">
              <path class="heart-outline"
                    d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1 7.8 7.8 7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z"
                    fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round"/>
              <path class="heart-filled"
                    d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1 7.8 7.8 7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z"
                    fill="currentColor"/>
            </svg>
          </button>

      {% else %}
        {# authenticated NON-OWNER #}
        <button
          type="button"
          class="ad-fav-btn absolute bottom-3 left-3 z-20{% if item.is_favorited %} is-active{% endif %}"
          data-fav-btn="1"
          data-guest="0"
          data-is-owner="0"
          data-url="{% url 'toggle_favorite' item.id %}"
          data-favorited="{% if item.is_favorited %}1{% else %}0{% endif %}"
          aria-label="{% trans 'Toggle favorite' %}"
          aria-pressed="{% if item.is_favorited %}true{% else %}false{% endif %}"
        >
          <svg class="w-5 h-5" viewBox="0 0 24 24" aria-hidden="true">
            <path class="heart-outline"
                  d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1 7.8 7.8 7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z"
                  fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"/>
            <path class="heart-filled"
                  d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1 7.8 7.8 7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z"
                  fill="currentColor"/>
          </svg>
        </button>
      {% endif %}

    {% else %}
      {# guest => always show heart (no url) #}
      <button
        type="button"
        class="ad-fav-btn absolute bottom-3 left-3 z-20"
        data-fav-btn="1"
        data-guest="1"
        data-is-owner="0"
        data-favorited="0"
        aria-label="{% trans 'Toggle favorite' %}"
        aria-pressed="false"
      >
        <svg class="w-5 h-5" viewBox="0 0 24 24" aria-hidden="true">
          <path class="heart-outline"
                d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1 7.8 7.8 7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z"
                fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round"/>
          <path class="heart-filled"
                d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1 7.8 7.8 7.8-7.8 1-1a5.5 5.5 0 0 0 0-7.8z"
                fill="currentColor"/>
        </svg>
      </button>
    {% endif %}

    <!-- CATEGORY BADGE -->
    {% if item.listing.category %}
      <span class="ad-cat-badge">
        {% if LANGUAGE_CODE == "ar" %}
          {{ item.listing.category.name_ar }}
        {% else %}
          {{ item.listing.category.name_en }}
        {% endif %}
      </span>
    {% endif %}

    <!-- FEATURED TAG -->
    {% if item.listing.is_featured or featured_card %}
      <span class="ad-featured-tag">مميز</span>
    {% endif %}
  </div>

  <!-- LOWER (overlay here, like mockup) -->
  <div class="ad-lower relative isolate">
    <div class="ad-hover-layer" aria-hidden="true">
      <div class="ad-hover-hint">
        <div class="txt"><span>عرض</span><span>الإعلان</span></div>
        <span class="arrow">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none"
               viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
               class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="m18.75 4.5-7.5 7.5 7.5 7.5m-6-15L5.25 12l7.5 7.5" />
          </svg>
        </span>
      </div>
    </div>

    <div class="ad-body">
      <h3 class="ad-title line-clamp-2" title="{{ item.listing.title }}">
        {{ item.listing.title }}
      </h3>

      <div class="ad-meta">
        <span>
          <svg class="ad-ico" viewBox="0 0 20 20" fill="none" aria-hidden="true">
            <path d="M10 18s6-5.05 6-10a6 6 0 1 0-12 0c0 4.95 6 10 6 10z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" />
            <circle cx="10" cy="8" r="2.3" stroke="currentColor" stroke-width="1.6" />
          </svg>
          <span>{% if item.listing.city %}{{ item.listing.city }}{% else %}—{% endif %}</span>
        </span>

        <span>
          <svg class="ad-ico" viewBox="0 0 20 20" fill="none" aria-hidden="true">
            <rect x="3" y="4" width="14" height="13" rx="2" stroke="currentColor" stroke-width="1.6"/>
            <path d="M7 2v4M13 2v4M4 8h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
          </svg>
          <span>
            {% with t=item.listing.updated_at|default:item.listing.created_at %}
              {% if t %}{{ t|timeago_ar }}{% endif %}
            {% endwith %}
          </span>
        </span>
      </div>
    </div>

    <div class="ad-footer">
      <div class="ad-seller">
          {% with u=item.listing.user s=item.listing.user.store %}
            {% if s and s.logo %}
              <img src="{{ s.logo.url }}" alt="{{ s.name|default:u.username|default:u.phone }}">
            {% elif u.profile_photo %}
              <img src="{{ u.profile_photo.url }}" alt="{{ u.username|default:u.phone }}">
            {% else %}
              <div class="ad-avatar-fallback">
                {% with fn=u.first_name|default:"" un=u.username|default:"" ph=u.phone|default:"" %}
                  {% if fn %}{{ fn|slice:":1"|upper }}
                  {% elif un %}{{ un|slice:":1"|upper }}
                  {% elif ph %}{{ ph|slice:":1"|upper }}
                  {% else %}?{% endif %}
                {% endwith %}
              </div>
            {% endif %}
          {% endwith %}


        {% with u=item.listing.user %}
          <span class="ad-seller-name">
            {% if u.store and u.store.name %}
              {{ u.store.name }}
            {% elif u.username %}
              {{ u.username }}
            {% else %}
              {{ u.first_name }}
            {% endif %}
          </span>
        {% endwith %}
      </div>

      <span class="ad-price">{{ item.price|floatformat:0 }} د.أ</span>
    </div>
  </div>

</article>

{% endwith %} {# HIDE_OWNER_FAV #}
