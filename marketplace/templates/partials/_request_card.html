{# templates/partials/request_card.html #}
{% load i18n timeago_ar %}

{# expects: req #}
<a href="{% url 'request_detail' req.id %}" class="block req-card-link">
  <article class="req-card group cursor-pointer flex flex-col relative">

    <!-- Hover Mask -->
    <div class="req-hover-mask"></div>

    <!-- Hint -->
    <div class="req-hint-container" aria-hidden="true">
      <div class="req-hint-text">
        <span>{% trans "View" %}</span>
        <span>{% trans "Request" %}</span>
      </div>
      <span class="req-hint-arrow">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
             class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="m18.75 4.5-7.5 7.5 7.5 7.5m-6-15L5.25 12l7.5 7.5" />
        </svg>
      </span>
    </div>

    <div class="p-4 pb-2 flex-1 relative">

      {# ✅ Featured badge (fixed) #}
      {% if req.featured or req.listing.is_featured %}
        <span class="req-badge-featured">مميز</span>
      {% endif %}

      <h3 class="req-title {% if req.featured or req.listing.is_featured %}req-title--pad{% endif %}">
        {{ req.listing.title }}
      </h3>

    </div>

    <div class="req-meta px-4">
      <span class="req-meta-item">
        <svg class="w-3.5 h-3.5 req-ico" viewBox="0 0 20 20" fill="none">
          <path d="M10 18s6-5.05 6-10a6 6 0 1 0-12 0c0 4.95 6 10 6 10z" stroke="currentColor" stroke-width="1.6" />
          <circle cx="10" cy="8" r="2.3" stroke="currentColor" stroke-width="1.6" />
        </svg>
        <span>
          {% if req.listing.city %}
            {{ req.listing.city.name_ar|default:req.listing.city }}
          {% else %}
            —
          {% endif %}
        </span>
      </span>

      <span class="req-meta-item">
        <svg class="w-3.5 h-3.5 req-ico" viewBox="0 0 20 20" fill="none">
          <rect x="3" y="4" width="14" height="13" rx="2" stroke="currentColor" stroke-width="1.6" />
          <path d="M7 2v4M13 2v4M4 8h12" stroke="currentColor" stroke-width="1.6" />
        </svg>
        <span>
          {% with r=req.listing.updated_at|default:req.listing.created_at %}
              {% if r %}{{ r|timeago_ar }}{% endif %}
            {% endwith %}
        </span>
      </span>
    </div>

    <!-- Footer -->
    <div class="req-footer">
      <div class="req-user">
        {# ✅ Avatar: image if exists, else first-letter fallback (same idea as item card) #}
        {% with avatar=req.listing.user.profile.avatar|default_if_none:"" %}
          {% if avatar %}
            <img src="{{ avatar.url }}" class="req-avatar" alt="">
          {% else %}
            <div class="req-avatar req-avatar-fallback" aria-hidden="true">
              {% with fn=req.listing.user.first_name|default:"" un=req.listing.user.username|default:"" %}
                {% if fn %}
                  {{ fn|slice:":1"|upper }}
                {% elif un %}
                  {{ un|slice:":1"|upper }}
                {% else %}
                  ?
                {% endif %}
              {% endwith %}
            </div>
          {% endif %}
        {% endwith %}

        <span class="req-user-name">
          {{ req.listing.user.get_full_name|default:req.listing.user.username|default:req.listing.user.phone|default:_("User") }}
        </span>
      </div>

      <div class="req-budget">
        <span class="req-budget-pill">لغاية</span>
        <span class="req-budget-value">
          {% if req.budget %}
            {{ req.budget|floatformat:0 }} د.أ
          {% else %}
            {% trans "حسب الطلب" %}
          {% endif %}
        </span>
      </div>
    </div>

  </article>
</a>
