{# templates/stores_list.html #}
{% extends "base.html" %}
{% load static humanize %}

{% block title %}المتاجر | ركن{% endblock %}

{% block base_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/stores_list.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8 px-4 space-y-6">

    <!-- Breadcrumb -->
    <nav aria-label="Breadcrumb" class="text-sm text-gray-500">
        <ol class="flex items-center gap-2">
            <li><a href="{% url 'home' %}" class="hover:text-[var(--rukn-orange)] transition">الرئيسية</a></li>
            <li class="text-gray-400">›</li>
            <li><span class="hover:text-[var(--rukn-orange)] transition font-extrabold">المتاجر</span></li>
        </ol>
    </nav>

    <!-- Hero Section -->
    <section class="relative rounded-[2rem] overflow-hidden mb-12 bg-slate-900 h-[350px] flex items-center justify-center">
        <img src="https://images.unsplash.com/photo-1441986300917-64674bd600d8?q=80&w=1600"
             class="absolute inset-0 w-full h-full object-cover opacity-40" alt="background">
        <div class="relative z-10 text-center px-4">
            <h2 class="text-white text-3xl md:text-5xl font-black mb-4">اكتشف أفضل المتاجر الموثوقة</h2>
            <p class="text-slate-200 text-lg mb-8 max-w-2xl mx-auto italic">
                ابحث عن المتجر المناسب، شاهد إعلاناته، وتواصل معه مباشرة عبر صفحة المتجر.
            </p>

            <!-- Enhanced Search Bar (HTMX) -->
            <div class="bg-white/90 backdrop-blur-lg p-2 rounded-2xl shadow-lg max-w-3xl mx-auto">
                <form id="storesSearchForm" method="get" action="{% url 'stores_list' %}" class="relative" onsubmit="return false;">
                    <input id="searchInput"
                           name="q"
                           type="text"
                           value="{{ q }}"
                           placeholder="ابحث باسم المتجر أو النشاط..."
                           hx-get="{% url 'stores_list_partial' %}"
                           hx-trigger="keyup changed delay:400ms, search"
                           hx-target="#resultsWrap"
                           hx-swap="outerHTML"
                           hx-push-url="{% url 'stores_list' %}"
                           hx-include="#storesFiltersForm"
                           class="w-full pl-16 pr-4 py-4 rounded-xl text-slate-700 font-semibold
                                  placeholder:text-slate-400 bg-slate-50 border border-slate-200
                                  focus:outline-none focus:border-orange-400 transition" />

                    <button type="submit"
                            class="absolute left-2 top-1/2 -translate-y-1/2 bg-orange-500 hover:bg-orange-600
                                   w-12 h-12 rounded-xl flex items-center justify-center shadow-md transition"
                            >
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M21 21l-4.35-4.35m1.1-4.65a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </section>

    {# Hidden form HTMX includes (q + categories) #}
    <form id="storesFiltersForm" class="hidden">
        {% for cid in selected_categories %}
            <input type="hidden" name="categories" value="{{ cid }}">
        {% endfor %}
    </form>

    <!-- Categories Filters -->
    <section class="mb-10">
        <div class="flex items-center justify-between mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
                <h3 class="text-xl font-black flex items-center gap-2">
                    <span class="w-2 h-6 bg-[#ff7a18] rounded-full"></span>
                    تصنيفات المتاجر
                </h3>
                <span class="text-sm text-slate-400 italic">
                    بإمكانك اختيار أكثر من تصنيف
                </span>
            </div>
        </div>

        <!-- Categories scroll -->
        <div class="relative">
            <button id="catLeft"
                    type="button"
                    class="absolute left-0 top-1/2 -translate-y-1/2 bg-white shadow rounded-full w-9 h-9
                           flex items-center justify-center z-10 hover:bg-orange-50 text-orange-500">
                ◀
            </button>

            <div id="categoryFilters"
                 class="flex gap-3 overflow-x-auto px-12 pb-1 scrollbar-hide scroll-smooth">

                <!-- All Button (HTMX) -->
                <button type="button"
                        class="category-chip {% if not selected_categories %}active{% endif %}"
                        data-category-id=""
                        hx-get="{% url 'stores_list_partial' %}"
                        hx-trigger="filtersChanged"
                        hx-target="#resultsWrap"
                        hx-swap="outerHTML"
                        hx-push-url="{% url 'stores_list' %}"
                        hx-include="#storesFiltersForm">
                    الكل
                </button>

                <!-- Category Buttons (HTMX) -->
                {% for cat in categories %}
                <button type="button"
                        class="category-chip {% if cat.id|stringformat:'s' in selected_categories %}active{% endif %}"
                        data-category-id="{{ cat.id }}"
                        hx-get="{% url 'stores_list_partial' %}"
                        hx-trigger="filtersChanged"
                        hx-target="#resultsWrap"
                        hx-swap="outerHTML"
                        hx-push-url="{% url 'stores_list' %}"
                        hx-include="#storesFiltersForm">
                    {{ cat.name_ar }}
                </button>

                {% empty %}
                <p class="text-sm text-gray-500 px-4">لا توجد أقسام متاحة</p>
                {% endfor %}
            </div>

            <button id="catRight"
                    type="button"
                    class="absolute right-0 top-1/2 -translate-y-1/2 bg-white shadow rounded-full w-9 h-9
                           flex items-center justify-center z-10 hover:bg-orange-50 text-orange-500">
                ▶
            </button>
        </div>
    </section>

    <!-- STORES SECTION -->
    <section class="py-8 bg-white">
        <div class="max-w-7xl mx-auto px-4 bg-white">
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-10">
                <h3 class="text-xl font-black flex items-center gap-2">
                    <span class="w-2 h-6 bg-[#ff7a18] rounded-full"></span>
                    المتاجر
                </h3>

                {# Hint + grid + load more now live inside resultsWrap (partial) #}
                {# The partial MUST output a wrapper <div id="resultsWrap"> ... </div> #}
            </div>

            {% include "partials/stores_list_results.html" %}
        </div>
    </section>

</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="{% static 'js/stores_list.js' %}"></script>

{% endblock %}
