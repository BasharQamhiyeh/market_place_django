{% extends 'base.html' %}
{% load i18n %}
{% load form_extras %}
{% block title %}{% trans "Create Item" %}{% endblock %}
{% block content %}

<h2>{% trans "Create Item" %}</h2>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <label>{% trans "Category" %}:</label>
    <select name="category" id="categorySelect" class="searchable-select" placeholder="{% trans 'Select Category' %}">
        <option value="">{% trans "Select Category" %}</option>
        {% for cat in categories %}
            <option value="{{ cat.id }}" {% if selected_category and selected_category.id == cat.id %}selected{% endif %}>
                {{ cat }}
            </option>
        {% endfor %}
    </select>

    <br><br>

    {% if selected_category %}
        {% for field in form %}
            {% if field.name != 'images' and "_other" not in field.name %}
                <div style="margin-bottom:10px;">
                    {{ field.label_tag }}<br>
                    {{ field }}

                    {# show Other only for dynamic attributes #}
                    {% if "attribute_" in field.name %}
                        <div id="{{ field.name }}_other_box"
                             style="display:none; margin-top:5px;">
                            {% with other_name=field.name|add:"_other" %}
                                {% if other_name in form.fields %}
                                    {{ form|get_bound_field:other_name }}
                                {% endif %}
                            {% endwith %}
                        </div>
                    {% endif %}

                    {% if field.errors %}
                        <div style="color:red;">{{ field.errors }}</div>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}


        <!-- Images -->
        <div style="margin-bottom:10px;">
            {{ form.images.label_tag }}<br>
            {{ form.images }}
            {% if form.images.errors %}
                <div style="color:red;">{{ form.images.errors }}</div>
            {% endif %}
        </div>
    {% endif %}

    <br>
    <button type="submit">{% trans "Post Item" %}</button>
</form>

<script>
document.getElementById('categorySelect').addEventListener('change', function() {
    const url = new URL(window.location.href);
    url.searchParams.set('category', this.value);
    window.location.href = url.toString();
});

// âœ… Toggle Visibility of Other Inputs
function updateOtherInputs() {
    document.querySelectorAll("select[name^='attribute_']").forEach(function(select) {
        const box = document.getElementById(select.name + "_other_box");
        if (!box) return;

        if (select.value === "__other__") {
            box.style.display = "block";
        } else {
            box.style.display = "none";
        }
    });
}

// Initialize on load
updateOtherInputs();

// Listen for selection changes
document.addEventListener('change', function(e) {
    if (e.target.matches("select[name^='attribute_']")) {
        updateOtherInputs();
    }
});
</script>

{% endblock %}
