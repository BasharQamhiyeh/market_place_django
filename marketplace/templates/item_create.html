{% extends 'base.html' %}
{% load i18n %}
{% load form_extras %}

{% block title %}{% trans "Create Item" %}{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
  <div class="card-header bg-dark text-white">
    <h4 class="mb-0">{% trans "Create Item" %}</h4>
  </div>

  <div class="card-body bg-white">
    <form method="post" enctype="multipart/form-data" class="vstack gap-3">
      {% csrf_token %}

      <!-- ✅ Category & Subcategory dropdown -->
      <div>
        <label for="categorySelect" class="form-label fw-semibold">{% trans "Category" %}</label>
        <select name="category" id="categorySelect"
                class="form-select searchable-select"
                data-placeholder="{% trans 'Select Category' %}">
          <option value="">{% trans "Select Category" %}</option>
          {% for cat in categories %}
            <!-- main category -->
            <option value="{{ cat.id }}"
              {% if selected_category and selected_category.id == cat.id %}selected{% endif %}>
              {{ cat }}
            </option>

            <!-- subcategories -->
            {% for sub in cat.subcategories.all %}
              <option value="{{ sub.id }}"
                {% if selected_category and selected_category.id == sub.id %}selected{% endif %}>
                &nbsp;&nbsp;— {{ sub }}
              </option>
            {% endfor %}
          {% endfor %}
        </select>
      </div>

      {% if selected_category %}
        {% for field in form %}
          {% if field.name != 'images' and "_other" not in field.name %}
            <div>
              <label class="form-label fw-semibold">{{ field.label }}</label>

              {# ✅ Make "title" a small input instead of textarea #}
              {% if field.name == "title" %}
                <input type="text"
                       name="{{ field.name }}"
                       id="id_{{ field.name }}"
                       value="{{ field.value|default_if_none:'' }}"
                       class="form-control"
                       maxlength="255"
                       required>
              {% else %}
                {{ field }}
              {% endif %}

              {% if "attribute_" in field.name %}
                <div id="{{ field.name }}_other_box" class="mt-2" style="display:none;">
                  {% with other_name=field.name|add:"_other" %}
                    {% if other_name in form.fields %}
                      {{ form|get_bound_field:other_name }}
                    {% endif %}
                  {% endwith %}
                </div>
              {% endif %}

              {% if field.errors %}
                <div class="text-danger small mt-1">{{ field.errors }}</div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}

        <!-- ✅ Image upload -->
        <div>
          <label class="form-label fw-semibold">{{ form.images.label }}</label>
          {{ form.images }}
          {% if form.images.errors %}
            <div class="text-danger small mt-1">{{ form.images.errors }}</div>
          {% endif %}
        </div>
      {% endif %}

      <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-jordan px-4">{% trans "Post Item" %}</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
(function() {
  function redirectWithCategory(val) {
    const url = new URL(window.location.href);
    if (val) { url.searchParams.set('category', val); } else { url.searchParams.delete('category'); }
    url.searchParams.delete('page');
    window.location.href = url.toString();
  }

  function bindCategoryChange() {
    const $select = $('#categorySelect');
    if (!$select.length) return;
    $select.off('change.souq select2:select.souq');
    $select.on('change.souq select2:select.souq', function(){ redirectWithCategory(this.value); });
  }

  function updateOtherInputs() {
    document.querySelectorAll("select[name^='attribute_']").forEach(function(select) {
      const box = document.getElementById(select.name + "_other_box");
      if (!box) return;
      box.style.display = (select.value === "__other__") ? "block" : "none";
    });
  }

  function onAttrChange(e) {
    if (e.target && e.target.matches("select[name^='attribute_']")) updateOtherInputs();
  }

  function bindOtherInputs() {
    document.removeEventListener('change', onAttrChange, true);
    document.addEventListener('change', onAttrChange, true);
    $(document).off('select2:select.souqAttr', "select[name^='attribute_']")
               .on('select2:select.souqAttr', "select[name^='attribute_']", updateOtherInputs);
  }

  document.addEventListener('DOMContentLoaded', function(){
    bindCategoryChange();
    updateOtherInputs();
    bindOtherInputs();
  });

  document.body.addEventListener('htmx:afterSwap', function(){
    bindCategoryChange();
    updateOtherInputs();
    bindOtherInputs();
  });
})();
</script>
{% endblock %}
