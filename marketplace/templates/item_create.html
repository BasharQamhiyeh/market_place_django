{% extends 'base.html' %}
{% load i18n %}
{% load form_extras %}

{% block title %}{% trans "New Announcement" %}{% endblock %}

{% block content %}
<div class="bg-white border border-gray-200 rounded-xl shadow">
  <div class="px-5 py-3 text-white rounded-t-xl" style="background-color: var(--jordan-green);">
    <h4 class="mb-0">{% trans "Publish Your Announcement" %}</h4>
  </div>

  <div class="p-6">
    <form method="post" enctype="multipart/form-data" class="space-y-6">
      {% csrf_token %}

      {% if selected_category %}

        <div>
          <label class="font-semibold block mb-1">
            {% trans "Product Photos" %}
            <span class="text-gray-500 text-sm block">{% trans "Click on a photo to mark it as the main photo." %}</span>
          </label>

          {{ form.images }}
          {% if form.images.errors %}
            <div class="text-red-600 text-sm mt-1">{{ form.images.errors }}</div>
          {% endif %}

          <input type="hidden" name="main_photo_index" id="main_photo_index">

          <div id="preview" class="mt-3 flex flex-wrap gap-3"></div>
        </div>

        <div>
          <label for="id_title" class="font-semibold block mb-1">{% trans "Title" %}</label>
          <input type="text" name="title" id="id_title"
                 value="{{ form.title.value|default_if_none:'' }}"
                 class="w-full border rounded px-3 py-2" maxlength="255" required>
        </div>

        <div>
          <label class="font-semibold block mb-1">{% trans "Category" %}</label>
          <select name="category" id="categorySelect"
                  class="w-full border rounded px-3 py-2 bg-white">
            <option value="">{% trans "Select Category" %}</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}" {% if selected_category.id == cat.id %}selected{% endif %}>{{ cat }}</option>
              {% for sub in cat.subcategories.all %}
                <option value="{{ sub.id }}" {% if selected_category.id == sub.id %}selected{% endif %}>&nbsp;&nbsp;— {{ sub }}</option>
              {% endfor %}
            {% endfor %}
          </select>
        </div>

        {% for field in form %}
          {% if field.name|slice:"0:10" == "attribute_" and not "_other" in field.name %}
            <div>
              <label class="font-semibold block mb-1" for="id_{{ field.name }}">{{ field.label }}</label>
              {{ field }}
              <div id="{{ field.name }}_other_box" class="hidden mt-2">
                {% with other_name=field.name|add:"_other" %}
                  {% if other_name in form.fields %}
                    {{ form|get_bound_field:other_name }}
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          {% endif %}
        {% endfor %}

        <div>
          <label class="font-semibold block mb-1">{% trans "Condition" %}</label>
          <div class="flex gap-6">
            <label class="flex items-center gap-2">
              <input type="radio" name="condition" value="new" class="h-4 w-4"
                     {% if form.condition.value == 'new' %}checked{% endif %}>
              <span>{% trans "New" %}</span>
            </label>

            <label class="flex items-center gap-2">
              <input type="radio" name="condition" value="used" class="h-4 w-4"
                     {% if form.condition.value == 'used' %}checked{% endif %}>
              <span>{% trans "Used" %}</span>
            </label>
          </div>
        </div>

        <div>
          <label class="font-semibold block mb-1">{% trans "Description" %}</label>
          <textarea name="description" id="id_description"
                    class="w-full border rounded px-3 py-2"
                    rows="6">{{ form.description.value|default_if_none:'' }}</textarea>
        </div>

        <div>
          <label class="font-semibold block mb-1">{% trans "Price" %}</label>
          {{ form.price }}
        </div>

        <div>
          <label class="font-semibold block mb-1">{% trans "City" %}</label>
          {{ form.city }}
        </div>

        <div class="flex justify-end">
          <button type="submit" class="px-5 py-2 bg-jordan text-white rounded hover:opacity-90">
            {% trans "Publish" %}
          </button>
        </div>

      {% else %}
        <div>
          <label class="font-semibold block mb-1">{% trans "Category" %}</label>
          <select name="category" id="categorySelect"
                  class="w-full border rounded px-3 py-2 bg-white">
            <option value="">{% trans "Select Category" %}</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}">{{ cat }}</option>
              {% for sub in cat.subcategories.all %}
                <option value="{{ sub.id }}">&nbsp;&nbsp;— {{ sub }}</option>
              {% endfor %}
            {% endfor %}
          </select>
        </div>
      {% endif %}
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/ui/trumbowyg.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/trumbowyg.min.js"></script>

<style>
  [id$="_other_box"] { display:none; }

  #preview img.preview-img {
    width:100px;
    height:100px;
    object-fit:cover;
    border-radius:.5rem;
    border:2px solid #ddd;
    cursor:pointer;
    transition:.2s;
  }

  #preview img.preview-img:hover {
    border-color:#777;
  }

  #preview img.preview-img.selected-main {
    border-color: var(--jordan-green);
    box-shadow: 0 0 6px var(--jordan-green);
  }
</style>

<script>
(function(){

  function redirectWithCategory(val){
    const url = new URL(window.location.href);
    if(val) url.searchParams.set('category', val);
    else url.searchParams.delete('category');
    window.location.href = url.toString();
  }

  function updateOtherInputs(){
    document.querySelectorAll('select[name^="attribute_"]').forEach(function(select){
      if (select.name.endsWith('_other')) return;
      const box = document.getElementById(select.name + '_other_box');
      if (!box) return;
      box.style.display = (select.value === '__other__') ? 'block' : 'none';
    });
  }

  document.addEventListener('change', function(e){
    if(e.target && e.target.name === 'images'){
      const preview = document.getElementById('preview');
      const mainInput = document.getElementById('main_photo_index');
      preview.innerHTML = '';
      if (mainInput) mainInput.value = '';

      Array.from(e.target.files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = ev => {
          const img = document.createElement('img');
          img.src = ev.target.result;
          img.dataset.index = index;
          img.classList.add('preview-img');

          img.addEventListener('click', () => {
            document.querySelectorAll('#preview img.preview-img')
              .forEach(i => i.classList.remove('selected-main'));

            img.classList.add('selected-main');
            if (mainInput) mainInput.value = index;
          });

          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }
  });

  document.addEventListener('DOMContentLoaded', function(){
    const catSel = document.getElementById('categorySelect');
    if (catSel){
      catSel.addEventListener('change', function(){
        redirectWithCategory(this.value);
      });
    }

    updateOtherInputs();
    document.addEventListener('change', function(e){
      if (e.target && e.target.matches('select[name^="attribute_"]')){
        updateOtherInputs();
      }
    });

    $('#id_description').trumbowyg({
      btns: [['strong','em','underline'],
             ['unorderedList','orderedList'],
             ['link'],
             ['removeformat']],
      autogrow: true,
      svgPath: 'https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/ui/icons.svg'
    });
  });

})();
</script>
{% endblock %}
