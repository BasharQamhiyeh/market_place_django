{% extends "admin/change_list.html" %}
{% load static %}

{% block content %}
<h1>ğŸ“‚ Category Hierarchy</h1>
<p class="help">
  Browse, edit, or add new subcategories directly from here.
</p>

<div id="category-tree"
     style="font-family: system-ui; margin: 20px 0; line-height: 1.6;"></div>

<script>
const treeData = {{ categories_json|safe }};
const addBaseUrl = "{% url 'admin:marketplace_category_add' %}";

function renderTree(data, level = 0) {
  let html = "<ul style='list-style:none;margin:0;padding-left:16px;'>";
  data.forEach(cat => {
    const hasChildren = cat.children && cat.children.length > 0;
    html += `
      <li style="margin:4px 0;">
        <span class="node" data-id="${cat.id}"
              style="cursor:pointer; user-select:none;">
          ${hasChildren ? "ğŸ“‚" : "ğŸ“„"}
          <b>${cat.name}</b>
        </span>
        <a href="${cat.edit_url}"
           style="margin-left:8px;font-size:13px;text-decoration:none;">âœï¸ Edit</a>
        <a href="${addBaseUrl}?parent=${cat.id}"
           style="margin-left:8px;font-size:13px;color:green;text-decoration:none;">â• Add</a>
        ${hasChildren ? `<ul class="children" style="margin-left:16px;">${renderTree(cat.children, level + 1)}</ul>` : ""}
      </li>
    `;
  });
  html += "</ul>";
  return html;
}

document.getElementById("category-tree").innerHTML = renderTree(treeData);

// --- Collapsible behavior (now starts expanded) ---
document.querySelectorAll("#category-tree .node").forEach(node => {
  node.addEventListener("click", e => {
    e.stopPropagation();
    const next = node.parentElement.querySelector(".children");
    if (next) {
      const isVisible = next.style.display !== "none";
      next.style.display = isVisible ? "none" : "block";
      node.textContent = node.textContent.replace(
        isVisible ? "ğŸ“‚" : "ğŸ“",
        isVisible ? "ğŸ“" : "ğŸ“‚"
      );
    }
  });
});
</script>

<style>
/* Hide the default Django changelist table and controls */
.change-list .results,
#changelist-search,
.actions,
#toolbar {
  display: none !important;
}

#category-tree ul {
  padding-left: 18px;
  margin: 0;
}

#category-tree li {
  margin-bottom: 3px;
}

#category-tree .node:hover {
  background-color: #f5f5f5;
  border-radius: 4px;
}
</style>
{% endblock %}
