{% extends 'base.html' %}
{% load i18n form_extras %}

{% block title %}{% trans "Edit Announcement" %}{% endblock %}

{% block content %}
<div class="card shadow-sm border-0">
  <div class="card-header text-white" style="background-color: var(--jordan-green);">
    <h4 class="mb-0">{% trans "Edit Announcement" %}</h4>
  </div>

  <div class="card-body bg-white">
    <form method="post" enctype="multipart/form-data" class="vstack gap-4">
      {% csrf_token %}

      <!-- Hidden inputs for main photo selection -->
      <input type="hidden" name="selected_main_photo" id="selected_main_photo" value="">
      <input type="hidden" name="main_photo_index" id="main_photo_index" value="">

      <!-- ✅ 1. Product Name -->
      <div>
        <label for="id_title" class="form-label fw-semibold">{% trans "Title" %}</label>
        <input type="text" name="title" id="id_title"
               value="{{ form.title.value|default_if_none:'' }}"
               class="form-control" maxlength="255" required>
      </div>

      <!-- ✅ 2. Category -->
      <div>
        <label for="categorySelect" class="form-label fw-semibold">{% trans "Category" %}</label>
        <select name="category" id="categorySelect" class="form-select" disabled>
          <option value="{{ category.id }}" selected>{{ category }}</option>
        </select>
      </div>

      <!-- ✅ 3. Dynamic Attributes -->
      {% for field in form.visible_fields %}
        {% if field.name|slice:"0:10" == "attribute_" and not "_other" in field.name %}
          <div>
            <label class="form-label fw-semibold" for="id_{{ field.name }}">{{ field.label }}</label>
            {{ field }}
            <div id="{{ field.name }}_other_box" class="mt-2" style="display:none;">
              {% with other_name=field.name|add:"_other" %}
                {% if other_name in form.fields %}
                  {{ form|get_bound_field:other_name }}
                {% endif %}
              {% endwith %}
            </div>
          </div>
        {% endif %}
      {% endfor %}

      <!-- ✅ 4. Condition -->
      <div>
        <label class="form-label fw-semibold d-block">{% trans "Condition" %}</label>
        <div class="d-flex gap-4">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="condition" id="condition_new"
                   value="new" {% if form.condition.value == 'new' %}checked{% endif %}>
            <label class="form-check-label" for="condition_new">{% trans "New" %}</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="condition" id="condition_used"
                   value="used" {% if form.condition.value == 'used' %}checked{% endif %}>
            <label class="form-check-label" for="condition_used">{% trans "Used" %}</label>
          </div>
        </div>
      </div>

      <!-- ✅ 5. Description -->
      <div>
        <label class="form-label fw-semibold" for="id_description">{% trans "Description" %}</label>
        <textarea name="description" id="id_description" class="form-control" rows="6">{{ form.description.value|default_if_none:'' }}</textarea>
      </div>

      <!-- ✅ 6. Price -->
      <div>
        <label for="id_price" class="form-label fw-semibold">{% trans "Price" %}</label>
        {{ form.price }}
      </div>

      <!-- ✅ 7. City -->
      <div>
        <label class="form-label fw-semibold" for="id_city">{% trans "City" %}</label>
        {{ form.city }}
      </div>

      <!-- ✅ 8. Existing Photos -->
      <div>
        <h6 class="fw-semibold mb-2">{% trans "Existing Photos" %}</h6>
        <div class="d-flex flex-wrap gap-2" id="existingPhotos">
          {% for photo in item.photos.all %}
            <div class="position-relative">
              <img src="{{ photo.image.url }}"
                   data-photo-id="{{ photo.id }}"
                   class="rounded existing-photo {% if photo.is_main %}selected-main{% endif %}"
                   style="width:120px;height:120px;object-fit:cover;border:3px solid {% if photo.is_main %}var(--jordan-green){% else %}#ccc{% endif %};border-radius:.5rem;cursor:pointer;transition:all .2s ease;">
              <button type="submit" name="delete_photo_{{ photo.id }}"
                      class="btn btn-sm btn-danger position-absolute top-0 end-0"
                      style="transform:translate(25%,-25%);border-radius:50%;padding:2px 6px;">×</button>
            </div>
          {% empty %}
            <p class="text-muted mb-0">{% trans "No photos uploaded." %}</p>
          {% endfor %}
        </div>
      </div>

      <!-- ✅ 9. Add More Photos (with preview) -->
      <div>
        <label class="form-label fw-semibold">{% trans "Add More Photos" %}</label>
        {{ form.images }}
        {% if form.images.errors %}
          <div class="text-danger small mt-1">{{ form.images.errors }}</div>
        {% endif %}
        <div id="preview" class="mt-3 d-flex flex-wrap gap-2"></div>
      </div>

      <!-- ✅ Buttons -->
      <div class="d-flex justify-content-end gap-2">
        <a href="{% url 'item_detail' item.id %}" class="btn btn-outline-secondary">{% trans "Cancel" %}</a>
        <button type="submit" class="btn btn-primary text-white px-4">{% trans "Save Changes" %}</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/ui/trumbowyg.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/trumbowyg.min.js"></script>

<style>
  .form-label {display:block;margin-bottom:.4rem;font-weight:600}
  form.vstack>div{margin-bottom:1rem}
  .trumbowyg-button-pane{display:flex;flex-wrap:wrap;align-items:center}
  .trumbowyg-button-pane button{margin-right:6px}
  [id$="_other_box"]{display:none}

  /* ✅ Highlight main photo */
  .existing-photo.selected-main,
  #preview img.preview-img.selected-main {
    border:4px solid var(--jordan-green)!important;
    box-shadow:0 0 12px 4px rgba(0,128,0,0.4);
    transform:scale(1.05);
    transition:all .2s ease-in-out;
  }
  .existing-photo:hover,
  #preview img.preview-img:hover {
    border-color:#999;
    transform:scale(1.03);
  }
</style>

<script>
(function(){
  function updateOtherInputs(){
    document.querySelectorAll("select[name^='attribute_']").forEach(select=>{
      if(select.name.endsWith("_other"))return;
      const box=document.getElementById(select.name+"_other_box");
      if(box)box.style.display=(select.value==="__other__")?"block":"none";
    });
  }

  // ✅ Preview new uploads
  document.addEventListener('change',e=>{
    if(e.target && e.target.name==='images'){
      const preview=document.getElementById('preview');
      preview.innerHTML='';
      document.getElementById('main_photo_index').value='';
      Array.from(e.target.files).forEach((file,index)=>{
        const reader=new FileReader();
        reader.onload=ev=>{
          const img=document.createElement('img');
          img.src=ev.target.result;
          img.classList.add('preview-img');
          img.dataset.index=index;
          img.style.cssText='width:100px;height:100px;object-fit:cover;border:2px solid #ddd;border-radius:.5rem;cursor:pointer;transition:all .2s';
          img.addEventListener('click',()=>{
            document.querySelectorAll('#preview img').forEach(i=>i.classList.remove('selected-main'));
            img.classList.add('selected-main');
            document.getElementById('main_photo_index').value=index;
            document.getElementById('selected_main_photo').value='';
          });
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }
  });

  // ✅ Click existing photo to set as main
  document.addEventListener('click',e=>{
    if(e.target && e.target.classList.contains('existing-photo')){
      document.querySelectorAll('.existing-photo').forEach(i=>i.classList.remove('selected-main'));
      e.target.classList.add('selected-main');
      document.getElementById('selected_main_photo').value=e.target.dataset.photoId;
      document.getElementById('main_photo_index').value='';
    }
  });

  document.addEventListener('DOMContentLoaded',function(){
    setTimeout(updateOtherInputs,0);
    document.addEventListener('change',e=>{
      if(e.target && e.target.matches("select[name^='attribute_']"))updateOtherInputs();
    });
    $('#id_description').trumbowyg({
      btns:[['strong','em','underline'],['unorderedList','orderedList'],['link'],['removeformat']],
      autogrow:true,
      svgPath:'https://cdn.jsdelivr.net/npm/trumbowyg@2.27.3/dist/ui/icons.svg'
    });
  });
})();
</script>
{% endblock %}
