{# item_create.html #}
{% extends "base.html" %}
{% load static i18n l10n form_extras %}

{% block base_css %}
<link rel="stylesheet" href="{% static 'css/post-ad.css' %}">
{% endblock %}

{% block content %}
<div class="px-4 sm:px-0">
  <div class="min-h-screen flex flex-col py-10 lg:py-16">

    <!-- Header -->
    <header class="max-w-5xl mx-auto w-full mb-6">
      <div class="flex flex-col lg:flex-row items-center lg:items-end justify-between gap-4">
        <div class="text-center lg:text-right">
          <p class="text-[12px] tracking-[0.2em] uppercase text-[var(--rukn-orange)] mb-1 font-semibold">
            ุชุนุฏูู ุฅุนูุงู
          </p>
          <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">
            ุนุฏูู ุฅุนูุงูู ูู ุฑูู
          </h1>
          <p class="text-xs md:text-sm text-[var(--muted)] mt-1">
            ุนุฏูู ุงูุชูุงุตูู ุซู ุงุญูุธ ูุฅุฑุณุงู ุฅุนูุงูู ูููุฑุงุฌุนุฉ ูุฌุฏุฏูุง.
          </p>
        </div>

        <div class="hidden sm:flex items-center gap-2 bg-white/80 border border-orange-100 rounded-full px-4 py-2 shadow-sm">
          <span class="text-xl">๐</span>
          <span class="text-xs text-[var(--muted)]">
            ุฅุนูุงู ูุงุถุญ + ุตูุฑ ุฌูุฏุฉ = ูุฑุต ุจูุน ุฃุนูู
          </span>
        </div>
      </div>
    </header>

    <!-- Grid -->
    <main class="max-w-5xl mx-auto mt-2 mb-10 w-full">
      <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,3fr),minmax(260px,1fr)] gap-8 lg:gap-10">

        <!-- LEFT -->
        <section class="container-box p-6 sm:p-8">
          {% if form.non_field_errors %}
            <div class="mb-4 text-red-700 bg-red-50 border border-red-200 rounded-lg px-3 py-2 text-xs flex items-center gap-2">
              <span>โ๏ธ</span> <span>{{ form.non_field_errors }}</span>
            </div>
          {% endif %}

          <form id="addAdForm" method="POST" enctype="multipart/form-data" class="space-y-3" data-redirect-url="{% url 'item_list' %}" data-single-submit>
            {% csrf_token %}
            <input type="hidden" name="form_token" value="{{ form_token }}">

            <!-- SECTION 1 -->
            <h3 class="text-xl font-bold text-[var(--rukn-orange)] flex items-center gap-2 mb-2">
              <span class="section-step">ูก</span>
              <span>ุชูุงุตูู ุงูุฅุนูุงู</span>
            </h3>

            <div class="border border-gray-200 rounded-2xl p-4 sm:p-5 space-y-4">

              <!-- TITLE -->
              <div>
                <label class="label">ุฃุถู ุนููุงู ูุฅุนูุงูู</label>
                <input type="text"
                       name="title"
                       id="adTitle"
                       placeholder="ูุซูุงู: ูุงุจุชูุจ HP ุฌุฏูุฏ"
                       class="input-field"
                       value="{{ form.title.value|default_if_none:'' }}">
                {% if form.title.errors %}<p class="field-error js-error">{{ form.title.errors }}</p>{% endif %}
              </div>

              <!-- CATEGORY (Hierarchical like mockup: parent -> sub -> sub) -->
              <div>
                <input type="hidden" id="lockCategoryEdit" value="1">

                <div id="category-levels"
                     class="flex flex-col gap-3 category-locked"
                     title="ูุง ูููู ุชุบููุฑ ุงููุณู ุจุนุฏ ูุดุฑ ุงูุฅุนูุงู. ุฅุฐุง ุงุฎุชุฑุช ูุณููุง ุฎุงุทุฆูุงุ ุงุญุฐู ุงูุฅุนูุงู ูุฃูุดุฆ ุฅุนูุงููุง ุฌุฏูุฏูุง.">
                </div>
                <input type="hidden"
                   name="category"
                   id="categoryIdInput"
                   value="{{ category.id }}">
                {% if form.category.errors %}<p class="field-error js-error">{{ form.category.errors }}</p>{% endif %}
              </div>

              <script id="category-tree-data" type="application/json">
                {{ category_tree_json|default:"[]"|safe }}
              </script>
              <script id="selected-category-path" type="application/json">
                {{ selected_category_path_json|default:"[]"|safe }}
              </script>

              <!-- DYNAMIC ATTRIBUTES -->
                <input type="hidden" id="listingId" value="{{ listing.id }}">
                <input type="hidden" id="listingType" value="{{ listing.type }}">
                <!-- DYNAMIC ATTRIBUTES -->
                <div id="attribute-fields">
                  {% include "partials/item_attributes.html" with form=form %}
                </div>


              <!-- PHOTOS -->
              <div>
                <label class="label">ุฃุถู ุตูุฑ</label>

                <div id="imageDropzone"
                     class="border-2 border-dashed border-orange-300 bg-orange-50/40 rounded-2xl p-6 sm:p-12 flex flex-col items-center justify-center text-center cursor-pointer">
                  <div class="text-4xl mb-2">๐ธ</div>
                  <p class="font-semibold text-gray-800 mb-1 text-sm">ุฃุถู ุตูุฑ ููุชุฌู</p>
                  <p class="text-xs text-[var(--muted)] mb-3 max-w-md leading-relaxed">
                    ููููู ุฅุถุงูุฉ ุฃูุซุฑ ูู ุตูุฑุฉุ ูุงุถุบุท ุนูู ุตูุฑุฉ ูุชุนููููุง ูู
                    <span class="text-[var(--rukn-orange)] font-semibold">ุตูุฑุฉ ุฑุฆูุณูุฉ</span>.
                  </p>
                  <span class="upload-btn">ุงุฎุชูุงุฑ ุงูุตูุฑ</span>
                </div>

                <input id="imageInput" name="images" type="file" accept="image/*" multiple class="hidden">
                <input type="hidden" name="main_photo_index" id="main_photo_index" value="">

                <div id="previewContainer" class="flex flex-wrap gap-3 mt-3"></div>

                {% if existing_photos %}
                  <div class="mt-4">
                    <p class="text-sm font-bold text-gray-700 mb-2">ุงูุตูุฑ ุงูุญุงููุฉ</p>

                    <input type="hidden" name="selected_main_photo" id="selected_main_photo"
                           value="{% for p in existing_photos %}{% if p.is_main %}{{ p.id }}{% endif %}{% endfor %}">

                    <div id="existingPhotos" class="flex flex-wrap gap-3">
                      {% for p in existing_photos %}
                        <div class="upload-preview {% if p.is_main %}main{% endif %}" data-photo-id="{{ p.id }}">
                          <img src="{{ p.image.url }}" alt="photo">
                          <button type="button" class="js-remove-existing" data-photo-id="{{ p.id }}">โ</button>
                        </div>

                        <input type="checkbox" class="hidden"
                               name="delete_photo_{{ p.id }}"
                               id="delete_photo_{{ p.id }}">
                      {% endfor %}
                    </div>

                    <p class="text-xs text-gray-500 mt-2">
                      ุงุถุบุท ุนูู ุตูุฑุฉ ูุชุนููููุง ูุฑุฆูุณูุฉุ ูุงุถุบุท โ ูุญุฐููุง.
                    </p>
                  </div>
                {% endif %}




                {% if form.images.errors %}<p class="field-error js-error">{{ form.images.errors }}</p>{% endif %}
              </div>
            </div>

            <!-- SECTION 2 -->
            <div class="pt-9">
              <h3 class="text-xl font-bold text-[var(--rukn-orange)] flex items-center gap-2 mb-2">
                <span class="section-step">ูข</span>
                <span>ุชูุงุตูู ุงูููุชุฌ ุฃู ุงูุฎุฏูุฉ</span>
              </h3>

              <div class="border border-gray-200 rounded-2xl p-4 sm:p-5 space-y-4 mt-3">

                <!-- CONDITION -->
                <div>
                  <label class="label">ุญุงูุฉ ุงูููุชุฌ</label>

                  <div id="conditionBox"
                       class="flex border border-gray-200 bg-white overflow-hidden rounded-2xl w-full sm:w-64 text-sm">
                    <button id="newBtn" type="button" class="flex-1 py-2.5 font-bold">ุฌุฏูุฏ</button>
                    <button id="usedBtn" type="button" class="flex-1 py-2.5 font-bold">ูุณุชุนูู</button>
                  </div>

                  <input type="hidden" id="conditionValue" name="condition" value="{% if form.condition.value %}{{ form.condition.value }}{% else %}new{% endif %}">
                  {% if form.condition.errors %}<p class="field-error js-error">{{ form.condition.errors }}</p>{% endif %}
                </div>

                <!-- DESCRIPTION -->
                <div>
                  <label class="label">ุงููุตู</label>
                  <textarea id="desc"
                            name="description"
                            rows="4"
                            placeholder="ุงูุชุจ ูุตูุงู ููุฌุฒุงู ููุงุถุญุงู ููููุชุฌ"
                            class="input-field text-sm">{{ form.description.value|default_if_none:'' }}</textarea>
                  {% if form.description.errors %}<p class="field-error js-error">{{ form.description.errors }}</p>{% endif %}

                  <button type="button" id="aiBtn"
                          class="mt-3 inline-flex items-center gap-2 px-4 py-2 bg-[var(--rukn-orange)] text-white rounded-lg font-semibold shadow hover:scale-105 w-full sm:w-auto justify-center text-sm">
                    ุชูููุฏ ุงููุตู ุจุงูุฐูุงุก ุงูุตูุงุนู
                  </button>
                </div>

                <!-- PRICE -->
                <div>
                  <label class="label">ุงูุณุนุฑ (ุฏ.ุฃ)</label>
                  <input type="number" step="0.01"
                         name="price"
                         id="priceInput"
                         placeholder="ูุซูุงู: 150"
                         class="input-field text-sm"
                         value="{{ form.price.value|default_if_none:''|unlocalize }}">
                  {% if form.price.errors %}<p class="field-error js-error">{{ form.price.errors }}</p>{% endif %}
                </div>




<!--                <script>-->
<!--                  // force ID for JS validation-->
<!--                  document.addEventListener("DOMContentLoaded", () => {-->
<!--                    const price = document.querySelector('input[name="price"]');-->
<!--                    if (price) price.id = "priceInput";-->
<!--                  });-->
<!--                </script>-->

              </div>
            </div>

            <!-- SECTION 3 -->
            <div class="pt-9">
              <h3 class="text-xl font-bold text-[var(--rukn-orange)] flex items-center gap-2 mb-2">
                <span class="section-step">ูฃ</span>
                <span>ุงููููุน ูุทุฑู ุงูุชูุงุตู</span>
              </h3>

              <div class="border border-gray-200 rounded-2xl p-4 sm:p-5 space-y-4 mt-3">

                <!-- CITY (mockup style dropdown + hidden real select value) -->
                <div class="relative">
                  <label class="label">ุงููุฏููุฉ</label>

                  <input id="cityInput"
                         type="text"
                         readonly
                         placeholder="ุงุฎุชุฑ ุงููุฏููุฉ"
                         class="input-field cursor-pointer text-sm"
                         value="{% if form.city.value %}{% for v,lbl in form.city.field.choices %}{% if v == form.city.value %}{{ lbl }}{% endif %}{% endfor %}{% endif %}">

                  <select id="citySelect" name="city" class="hidden">
                    {% for value, label in form.city.field.choices %}
                      <option value="{{ value }}" {% if form.city.value == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>

                  <div id="cityList" class="absolute z-[9999] mt-2 w-full bg-white border-2 border-gray-200 rounded-xl shadow-lg hidden">
                    <div class="p-2 border-b border-orange-100">
                      <input id="citySearch" type="text" placeholder="๐ ุจุญุซ..." class="w-full border border-gray-200 rounded-lg py-1.5 px-3 text-sm">
                    </div>
                    <ul id="cityOptions" class="max-h-52 overflow-y-auto text-sm">
                      {% for value, label in form.city.field.choices %}
                        {% if value %}
                          <li class="p-2 hover:bg-orange-50 cursor-pointer" data-value="{{ value }}">{{ label }}</li>
                        {% endif %}
                      {% endfor %}
                    </ul>
                  </div>

                  {% if form.city.errors %}<p class="field-error js-error">{{ form.city.errors }}</p>{% endif %}
                </div>

                <!-- SHOW PHONE -->
                <div class="mt-4 pt-4 border-t border-dashed border-gray-200">
                  <label class="label">ุชูุถููุงุช ุงูุชูุงุตู</label>
                  <div class="bg-gray-100/75 rounded-xl px-3 py-3 sm:px-4 sm:py-3">
                    <label class="flex items-center gap-3 cursor-pointer select-none">
                      <input
                        type="checkbox"
                        name="show_phone"
                        class="w-5 h-5 accent-[var(--rukn-orange)]"
                        {% if form.is_bound %}
                          {% if form.data.show_phone %}checked{% endif %}
                        {% else %}
                          {% if form.instance.show_phone %}checked{% endif %}
                        {% endif %}
                      >
                      <span class="font-semibold text-gray-800 text-sm">ุฅุธูุงุฑ ุฑูู ุงููุงุชู ูู ุงูุฅุนูุงู</span>
                    </label>
                    <p class="text-xs text-[var(--muted)] mt-1 pr-7 leading-relaxed">
                      ูู ุญุงู ุชูุนูู ูุฐุง ุงูุฎูุงุฑุ ุณูุชู ุนุฑุถ ุฑูู ูุงุชูู ูููุดุชุฑูู ุงูููุชูููู ูุชุณููู ุงูุชูุงุตู ุงููุจุงุดุฑ.
                    </p>
                  </div>
                </div>

              </div>
            </div>

            <!-- TERMS -->
            <div class="pt-9">
              <div id="termsBox" class="border border-gray-200 rounded-2xl p-4 sm:p-5 space-y-4 text-sm">
                <nav id="termsNav" class="flex-row gap-1 text-[8px] sm:text-xs mb-2 overflow-x-auto sm:py-3 sm:px-1 py-2 px-1 rounded-2xl bg-gray-100/75">
                  <button type="button" class="nav-link active" data-tab="accuracy">ุตุญุฉ ุงูุจูุงูุงุช</button>
                  <button type="button" class="nav-link" data-tab="legal">ูุญุชูู ุขูู</button>
                  <button type="button" class="nav-link" data-tab="language">ุขุฏุงุจ ุงููุดุฑ</button>
                  <button type="button" class="nav-link" data-tab="management">ูุณุคูููุฉ ุงูููุนูู</button>
                </nav>

                <div id="termsScroll" class="text-xs leading-relaxed rounded-xl bg-gray-100/75 px-4 pb-4 pt-2">
                  <div class="term-panel active" data-tab="accuracy">
                    <h6 class="font-bold text-gray-800 text-sm mb-1">ุตุญุฉ ุงูุจูุงูุงุช</h6>
                    <p class="mb-2">ููุชุฒู ุงูููุนูู ุจุฅุฏุฎุงู ุจูุงูุงุช ุตุญูุญุฉุ ุฏูููุฉุ ูุบูุฑ ูุถููุฉ ุนู ุงูููุชุฌ ุฃู ุงูุฎุฏูุฉุ ุจูุง ูู ุฐูู
                    ุงููุตูุ ุงูุญุงูุฉุ ุงูุณุนุฑุ ููุณุงุฆู ุงูุชูุงุตู. ูุฃู ุฅุฎูุงุก ุฃู ุชุญุฑูู ูุชุนูุฏ ูููุนูููุงุช ูุฏ ูุคุฏู ุฅูู
                    ุฅููุงู ุฃู ุญุฐู ุงูุฅุนูุงู ุฏูู ุฅุดุนุงุฑุ ูุน ุฅููุงููุฉ ุญุธุฑ ุญุณุงุจ ุงูููุนูู ููู ุณูุงุณุฉ ููุตุฉ ุฑูู.</p>
                  </div>
                  <div class="term-panel hidden" data-tab="legal">
                    <h6 class="font-bold text-gray-800 text-sm mb-1">ูุญุชูู ุขูู</h6>
                    <p class="mb-2">ููุญุธุฑ ุงุณุชุฎุฏุงู ุงูููุตุฉ ููุดุฑ ุฃู ุฅุนูุงู ูุชุถูู ููุชุฌุงุช ุฃู ุฎุฏูุงุช ูุฎุงููุฉ ููููุงููู ุฃู ุงูุฃูุธูุฉ
                    ุงููุนููู ุจูุงุ ุฃู ุชูุชูู ุงูุญููู ุงูููุฑูุฉ ุฃู ุงูุฎุตูุตูุฉ ุฃู ุฃู ุญููู ูุธุงููุฉ ููุบูุฑ. ููุง ููููุน
                    ูุดุฑ ุฃู ูุญุชูู ูุชุถูู ุงุญุชูุงูุงูุ ุฃู ุชุฑููุฌุงู ูุณูุน ุฃู ุฎุฏูุงุช ูุญุธูุฑุฉ ูุธุงูุงู. ููุญู
                    ูููุตุฉ ุฑูู ุญุฐู ุฃู ุฅุนูุงู ูู ูุฐุง ุงูููุน ุฏูู ูุณุคูููุฉ ุนูููุง.</p>
                  </div>
                  <div class="term-panel hidden" data-tab="language">
                    <h6 class="font-bold text-gray-800 text-sm mb-1">ุขุฏุงุจ ุงููุดุฑ</h6>
                    <p class="mb-2">ูุฌุจ ุฃู ููุชุฒู ุงูููุนูู ุจุงุณุชุฎุฏุงู ูุบุฉ ูุญุชุฑูุฉ ููุงุฆูุฉ ูู ุงูุนููุงู ูุงููุตู ูุงูุฑุณุงุฆูุ
                    ูููููุน ุงุณุชุฎุฏุงู ุงูุฃููุงุธ ุงููุณูุฆุฉุ ุงูุนูุตุฑูุฉุ ุฃู ุฃู ูุญุชูู ูููู ุฃู ุบูุฑ ุฃุฎูุงูู. ููุง ููููุน
                    ุชุถููู ุฃู ุฅุดุงุฑุงุช ุฏูููุฉ ุฃู ุณูุงุณูุฉ ุฃู ูุฏ ุชูุณุจุจ ุฅุณุงุกุฉ ููุบูุฑ.</p>
                  </div>
                  <div class="term-panel hidden" data-tab="management">
                    <h6 class="font-bold text-gray-800 text-sm mb-1">ูุณุคูููุฉ ุงูููุนูู</h6>
                    <p class="mb-2">ููุชุฒู ุงูููุนูู ุจุชุญุฏูุซ ุฃู ุญุฐู ุงูุฅุนูุงู ููุฑ ุจูุน ุงูููุชุฌ ุฃู ุชุบูุฑ ุญุงูุชู ุจุดูู ุฌููุฑู. ูุชุญุชูุธ
                    ููุตุฉ ุฑูู ุจุงูุญู ูู ุชุนุฏูู ุฃู ุฅุฎูุงุก ุฃู ุญุฐู ุฃู ุฅุนูุงู ุชุฑู ุฃูู ูุฎุงูู ููุฐู ุงูุดุฑูุท ุฃู ูุณูุก
                    ูุชุฌุฑุจุฉ ุงููุณุชุฎุฏูููุ ุฏูู ุฃู ุงูุชุฒุงู ุจุงูุชุนููุถ.</p>
                  </div>
                </div>

                <label class="flex items-start gap-3 cursor-pointer select-none pt-3 mt-2 border-t border-gray-200">
                  <input type="checkbox" id="acceptTerms" name="accept_terms" class="mt-1 w-5 h-5 accent-[var(--rukn-orange)]">
                  <span class="text-gray-700 leading-relaxed text-xs sm:text-sm">
                    ุฃุคูุฏ ุฃููู ูุฑุฃุช ููููุช ุดุฑูุท ูุดุฑ ุงูุฅุนูุงู ุฃุนูุงูุ ูุฃูุงูู ุนูู ุงูุงูุชุฒุงู ุจูุง.
                  </span>
                </label>
              </div>

              <p class="text-[10px] sm:text-xs text-gray-500 leading-relaxed mt-2 px-3">
                ุจุงูููุฑ ุนูู <strong>"ูุดุฑ ุงูุฅุนูุงู"</strong>ุ ูุฅูู ุชูุฑ ูุชูุงูู ุนูู ุงูุดุฑูุท.
              </p>
            </div>

            <!-- SUBMIT -->
            <div class="pt-4 text-center">
              <button type="submit" class="submit-btn mt-2 px-10 py-3 text-base w-full sm:w-1/2" data-submit-btn>
                ุชุนุฏูู ุงูุฅุนูุงู
              </button>
            </div>

          </form>
        </section>

        <!-- RIGHT -->
        <aside class="space-y-5">
          <section class="container-box p-5 sm:p-6 h-fit lg:sticky lg:top-0">
            <div class="relative z-10 pt-4">
              <h2 class="text-xl font-bold text-[var(--rukn-orange)] mb-4 text-center lg:text-right flex items-center gap-2 justify-center lg:justify-start">
                ๐ก ูุตุงุฆุญ ูุฅุนูุงู ูุงุฌุญ
              </h2>

              <div class="space-y-3 text-sm text-[var(--muted)]">
                <div class="tip-card p-3 text-right">
                  <div class="font-semibold text-gray-800 mb-1 text-sm">๐ธ ุตูุฑ ุฌุฐุงุจุฉ</div>
                  <p class="leading-relaxed text-xs sm:text-sm">ุงูุชูุท ุตูุฑูุง ูุงุถุญุฉ ูู ุฒูุงูุง ูุชุนุฏุฏุฉ ูุนุฑุถ ุงูููุชุฌ ุจุฃูุถู ุดูู.</p>
                </div>
                <div class="tip-card p-3 text-right">
                  <div class="font-semibold text-gray-800 mb-1 text-sm">๐๏ธ ุนููุงู ูุงุถุญ</div>
                  <p class="leading-relaxed text-xs sm:text-sm">ุงุฎุชุฑ ุนููุงููุง ุฏููููุง ูุตู ููุชุฌู ุจุงุญุชุฑุงููุฉ.</p>
                </div>
                <div class="tip-card p-3 text-right">
                  <div class="font-semibold text-gray-800 mb-1 text-sm">๐ ูุตู ุตุงุฏู</div>
                  <p class="leading-relaxed text-xs sm:text-sm">ุงุดุฑุญ ุชูุงุตูู ุงูููุชุฌ ููููุฒุงุชู ุจูุถูุญ ูุตุฏู ูุชูุณุจ ุซูุฉ ุงููุดุชุฑู.</p>
                </div>
                <div class="tip-card p-3 text-right">
                  <div class="font-semibold text-gray-800 mb-1 text-sm">๐ฐ ุณุนุฑ ููุงุณุจ</div>
                  <p class="leading-relaxed text-xs sm:text-sm">ุญุฏุฏ ุณุนุฑูุง ุนุงุฏููุง ุจูุงุกู ุนูู ุญุงูุฉ ุงูููุชุฌ ูุงูุฃุณุนุงุฑ ูู ุงูุณูู.</p>
                </div>
                <div class="tip-card p-3 text-right">
                  <div class="font-semibold text-gray-800 mb-1 text-sm">๐ ูููุน ุฏููู</div>
                  <p class="leading-relaxed text-xs sm:text-sm">ุงุฎุชูุงุฑ ุงููุฏููุฉ ุงูุตุญูุญุฉ ูุณุงุนุฏ ุนูู ูุตูู ุฅุนูุงูู ูููุฆุฉ ุงูููุงุณุจุฉ.</p>
                </div>
                <div class="tip-card p-3 text-right">
                  <div class="font-semibold text-gray-800 mb-1 text-sm">โฑ๏ธ ุงูุฑุฏ ุงูุณุฑูุน</div>
                  <p class="leading-relaxed text-xs sm:text-sm">ุชูุงุนู ุณุฑูุน ูุน ุงูุฑุณุงุฆู ูุฒูุฏ ูู ูุฑุต ุงูุจูุน ููุธูุฑ ุฌุฏูุชู.</p>
                </div>
              </div>
            </div>
          </section>
        </aside>

      </div>
    </main>

  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="{% static 'js/post-ad-django.js' %}"></script>
{% endblock %}