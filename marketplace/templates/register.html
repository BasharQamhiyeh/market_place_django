{% extends "base.html" %}
{% load static %}

{% block title %}Ø±ÙƒÙ† â€” Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨{% endblock %}

{% block base_css %}
<link rel="stylesheet" href="{% static 'css/signup.css' %}">
{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center px-4">
  <div id="signupContainer" class="auth-card w-full">

    <div class="auth-header">
      <div class="flex justify-center items-center pb-8">
        <img
          src="{% static 'images/logo.png' %}"
          alt="Ø´Ø¹Ø§Ø± Ø±ÙƒÙ†"
          class="h-12 w-auto object-contain"
        />
      </div>

      <h1 class="auth-title">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙÙŠ Ø±ÙƒÙ†</h1>
      <p class="auth-subtitle">Ø³Ø¬Ù‘Ù„ Ù…Ø¹Ù†Ø§ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ù†ØµØ©</p>
    </div>

    <!-- STEP 1: Mobile -->
    <form id="mobileForm">
      {% csrf_token %}
      <label class="label">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</label>
      <input
        type="text"
        id="mobile"
        inputmode="numeric"
        maxlength="10"
        class="input-field text-right placeholder:text-right"
        placeholder="Ù…Ø«Ø§Ù„: 0790000000"
      >
      <div id="mobileErr"></div>

      <button id="sendOtpBtn" type="submit" class="submit-btn text-base block">
        Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚
      </button>
    </form>

    <!-- STEP 3: Full signup -->
    <form id="signupForm"
          class="space-y-6 {% if restore_step == 'details' %}mt-4{% else %}hidden mt-4{% endif %}"
          method="post" action="{% url 'complete_signup' %}">
      {% csrf_token %}

      {# âœ… Global (non-field) errors like "passwords don't match", etc #}
      {% if signup_form and signup_form.non_field_errors %}
        <div class="bg-red-100 text-red-700 p-3 rounded-lg text-sm">
          {{ signup_form.non_field_errors.0 }}
        </div>
      {% endif %}

      <!-- Verified phone stored here -->
      <input type="hidden" id="verifiedMobile" name="verifiedMobile"
             value="{% if signup_form %}{{ signup_form.data.verifiedMobile|default:verified_phone }}{% else %}{{ verified_phone|default:'' }}{% endif %}">

      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <label class="label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ *</label>
          <input type="text"
                 id="firstName"
                 name="first_name"
                 class="input-field {% if signup_form and signup_form.first_name.errors %}input-error{% endif %}"
                 value="{% if signup_form %}{{ signup_form.data.first_name|default:'' }}{% endif %}"
                 placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯">
          <div id="firstNameErr">
            {% if signup_form and signup_form.first_name.errors %}
              <p class="field-error">âš ï¸ {{ signup_form.first_name.errors.0 }}</p>
            {% endif %}
          </div>
        </div>

        <div class="flex-1">
          <label class="label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ø®ÙŠØ± *</label>
          <input type="text"
                 id="lastName"
                 name="last_name"
                 class="input-field {% if signup_form and signup_form.last_name.errors %}input-error{% endif %}"
                 value="{% if signup_form %}{{ signup_form.data.last_name|default:'' }}{% endif %}"
                 placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£Ø­Ù…Ø¯">
          <div id="lastNameErr">
            {% if signup_form and signup_form.last_name.errors %}
              <p class="field-error">âš ï¸ {{ signup_form.last_name.errors.0 }}</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Account type -->
      <div class="mt-2">
        <label class="label">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨ *</label>

        {# decide selected type from posted data if present #}
        {% with acc_type=signup_form.data.condition|default:"personal" %}
          <div id="conditionBox"
               class="flex border border-gray-200 shadow-sm bg-white overflow-hidden rounded-lg w-full">
            <button id="btnPersonal" type="button"
              class="flex-1 py-2.5 text-sm font-bold
                     {% if acc_type != 'store' %}toggle-active bg-[var(--rukn-orange)] text-white{% else %}text-[var(--muted)] bg-white{% endif %}">
              ÙØ±Ø¯
            </button>

            <button id="btnStore" type="button"
              class="flex-1 py-2.5 text-sm font-bold
                     {% if acc_type == 'store' %}toggle-active bg-[var(--rukn-orange)] text-white{% else %}text-[var(--muted)] bg-white{% endif %}">
              ØªØ§Ø¬Ø±
            </button>
          </div>

          {# âœ… IMPORTANT: add name so backend can read it later #}
          <input type="hidden" id="conditionValue" name="condition" value="{{ acc_type }}">
        {% endwith %}
      </div>

      <!-- Store box -->
      {% with acc_type=signup_form.data.condition|default:"personal" %}
      <div id="storeBox" class="{% if acc_type == 'store' %}mt-4{% else %}hidden mt-4{% endif %} rounded-2xl shadow-lg overflow-hidden">
        <div class="bg-[var(--rukn-orange)] text-white px-5 py-3 flex items-center gap-2">
          <h3 class="font-bold text-lg">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</h3>
        </div>

        <div class="bg-white p-6 space-y-5">
          <div>
            <label class="label">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø± *</label>
            <input type="text"
                   id="storeName"
                   name="store_name"
                   class="input-field {% if signup_form and signup_form.store_name.errors %}input-error{% endif %}"
                   value="{% if signup_form %}{{ signup_form.data.store_name|default:'' }}{% endif %}"
                   placeholder="Ù…Ø«Ø§Ù„: Ù…ØªØ¬Ø± Ø§Ù„Ù…Ù‡Ù†Ø¯">
            <div id="storeNameErr">
              {% if signup_form and signup_form.store_name.errors %}
                <p class="field-error">âš ï¸ {{ signup_form.store_name.errors.0 }}</p>
              {% endif %}
            </div>
          </div>

          <div>
            <label class="label">Ù„ÙˆØ¬Ùˆ Ø§Ù„Ù…ØªØ¬Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>

            <div class="flex items-center gap-4 mt-2">
              <div class="relative w-24 h-24 rounded-3xl bg-gray-50 border border-gray-200 shadow-sm flex items-center justify-center overflow-hidden">
                <button id="removeLogo" type="button"
                  class="submit-btn hidden absolute top-1 right-1 bg-white text-red-600 border border-red-400 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow">
                  âœ–
                </button>

                <img id="logoPreview" class="w-full h-full hidden" alt="logo">
                <span id="logoPlaceholder" class="text-4xl text-gray-400">ğŸ“·</span>
              </div>

              <label for="storeLogo"
                class="cursor-pointer bg-[var(--rukn-orange)] text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-[#e56a00] transition">
                Ø§Ø®ØªØ± ØµÙˆØ±Ø©
              </label>

              {# note: file input won't repopulate on reload by browser security #}
              <input type="file" id="storeLogo" name="store_logo" accept="image/*" class="hidden">
            </div>

            <div id="storeLogoErr">
              {% if signup_form and signup_form.store_logo.errors %}
                <p class="field-error">âš ï¸ {{ signup_form.store_logo.errors.0 }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endwith %}

      <!-- Passwords -->
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <label class="label mt-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
          <div class="relative">
            <input type="password"
                   id="pass1"
                   name="password"
                   class="input-field {% if signup_form and signup_form.password.errors %}input-error{% endif %}"
                   placeholder="********">
            <button type="button" id="togglePass1"
              class="absolute top-1/2 -translate-y-1/2 left-4 text-gray-500"></button>
          </div>
          <div id="pass1Err">
            {% if signup_form and signup_form.password.errors %}
              <p class="field-error">âš ï¸ {{ signup_form.password.errors.0 }}</p>
            {% endif %}
          </div>
        </div>

        <div class="flex-1">
          <label class="label mt-2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
          <div class="relative">
            <input type="password"
                   id="pass2"
                   name="password2"
                   class="input-field {% if signup_form and signup_form.password2.errors %}input-error{% endif %}"
                   placeholder="********">
            <button type="button" id="togglePass2"
              class="absolute top-1/2 -translate-y-1/2 left-4 text-gray-500"></button>
          </div>
          <div id="pass2Err">
            {% if signup_form and signup_form.password2.errors %}
              <p class="field-error">âš ï¸ {{ signup_form.password2.errors.0 }}</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Terms -->
      <div class="mt-2 flex items-start gap-3 select-none">
        {# If you later add accept_terms to the Django form, bind checked from POST #}
        <input type="checkbox" id="acceptTerms" name="accept_terms" class="checkbox-large mt-1"
               {% if signup_form and signup_form.data.accept_terms %}checked{% endif %}>
        <span class="text-sm text-gray-700 leading-relaxed">
          Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰
          <button type="button" id="termsLink"
                  class="text-[var(--rukn-orange)] font-semibold hover:underline">
            Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…
          </button>
          Ùˆ
          <button type="button" id="privacyLink"
                  class="text-[var(--rukn-orange)] font-semibold hover:underline">
            Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©
          </button>
        </span>
      </div>
      <div id="acceptTermsErr">
        {% if signup_form and signup_form.accept_terms.errors %}
          <p class="field-error">âš ï¸ {{ signup_form.accept_terms.errors.0 }}</p>
        {% endif %}
      </div>

      <button type="submit" class="submit-btn mt-2 px-10 py-3 text-base w-full">
        Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
      </button>
    </form>
  </div>
</div>

<!-- OTP success popup -->
<div id="otpSuccessPopup" class="success-popup-bg hidden" style="z-index:9999;">
  <div class="success-popup">
    <div class="flex flex-col items-center mb-3">
      <div class="w-14 h-14 rounded-2xl bg-orange-50 flex items-center justify-center text-[var(--rukn-orange)] text-3xl mb-2">
        âœ“
      </div>
      <h2 class="text-lg font-extrabold text-gray-900">ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­</h2>
      <p class="text-sm text-gray-500 text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...</p>
    </div>
  </div>
</div>

<!-- Verify popup -->
<div id="verifyPopup" class="popup-bg hidden">
  <div class="popup-box">

    <div class="flex items-center justify-center gap-3 mb-4">
      <div class="w-10 h-10 rounded-2xl bg-orange-100 flex items-center justify-center text-[var(--rukn-orange)] text-2xl">
        ğŸ”
      </div>
      <div class="text-right">
        <h2 class="text-lg font-extrabold text-gray-900">ØªØ£ÙƒÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</h2>
        <p class="text-xs text-gray-500 mt-1">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…ÙƒÙˆÙ‘Ù† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù… Ù„Ø¥ØªÙ…Ø§Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</p>
      </div>
    </div>

    <label class="label text-sm mt-2">Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ *</label>
    <input type="text" id="verifyCodeInput" inputmode="numeric" maxlength="4"
           class="input-field font-bold text-2xl mb-1 text-center tracking-[0.4em]"
           placeholder="0 0 0 0">
    <div id="verifyCodeErr"></div>

    <div class="flex gap-3 mt-5">
      <button id="checkVerifyCode" type="button"
        class="flex-1 py-3 rounded-xl font-bold bg-[var(--rukn-orange)] text-white hover:bg-[#e56a00] transition duration-200 shadow-md">
        ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù†
      </button>

      <button id="closeVerify" type="button"
        class="flex-1 py-3 rounded-xl font-semibold bg-gray-100 text-gray-700 border border-gray-300 hover:bg-gray-200 transition duration-200">
        Ø¥Ù„ØºØ§Ø¡
      </button>
    </div>
  </div>
</div>

<!-- Success popup -->
<div id="successPopup" class="success-popup-bg hidden">
  <div class="success-popup">
    <div class="flex flex-col items-center mb-4">
      <div class="w-14 h-14 rounded-2xl bg-orange-50 flex items-center justify-center text-[var(--rukn-orange)] text-3xl mb-3">
        âœ“
      </div>
      <h2 class="text-lg font-extrabold text-gray-900 mb-1">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­</h2>
      <p class="text-sm text-gray-500 text-center leading-relaxed">
        ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù†ØµØ© Ø±ÙƒÙ†.
      </p>
    </div>

    <button id="closeSuccess" type="button"
      class="w-full mt-2 bg-[var(--rukn-orange)] text-white py-3 rounded-xl font-bold hover:bg-[#e56a00] transition duration-200 shadow-md">
      Ø­Ø³Ù†Ø§Ù‹
    </button>
  </div>
</div>

<!-- Terms popup -->
<div id="termsPopup" class="popup-bg hidden">
  <div class="popup-box">
    <h2 class="text-lg font-bold text-[var(--rukn-orange)] mb-4 text-center">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</h2>
    <div class="popup-content text-sm leading-relaxed text-gray-800">
      <p>...</p>
    </div>
    <button id="closeTerms" type="button"
      class="w-full mt-4 bg-[var(--rukn-orange)] text-white py-3 rounded-xl font-bold hover:bg-[#e56a00] transition">
      Ø¥ØºÙ„Ø§Ù‚
    </button>
  </div>
</div>

<!-- Privacy popup -->
<div id="privacyPopup" class="popup-bg hidden">
  <div class="popup-box max-h-[80vh]">
    <h2 class="text-lg font-bold text-[var(--rukn-orange)] mb-3 text-center">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</h2>
    <div class="popup-content text-sm leading-relaxed text-gray-800">
      <p>...</p>
    </div>
    <button id="closePrivacy" type="button"
      class="w-full mt-4 bg-[var(--rukn-orange)] text-white py-3 rounded-xl font-bold hover:bg-[#e56a00] transition">
      Ø¥ØºÙ„Ø§Ù‚
    </button>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
  window.SIGNUP_SEND_OTP_URL = "{% url 'ajax_send_signup_otp' %}";
  window.SIGNUP_VERIFY_OTP_URL = "{% url 'ajax_verify_signup_otp' %}";
  window.SIGNUP_RESTORE_STEP = "{{ restore_step|default:'' }}";
  window.SIGNUP_VERIFIED_PHONE = "{{ verified_phone|default:'' }}";
</script>
<script src="{% static 'js/signup_django.js' %}" defer></script>
{% endblock %}
